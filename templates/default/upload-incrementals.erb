#!/usr/bin/env bash

set -e

source /etc/cassandra/snapshots.conf

root_dir=`dirname "<%= node['et_cassandra']['config']['data_file_directories'].first %>"`
data_dirs="<%= node['et_cassandra']['config']['data_file_directories'].join(' ') %>"
work_dir="${root_dir}/backup_work_dir"
old_pwd="$PWD"

mkdir -p "${work_dir}"

backup_date=`date +%Y-%m-%dT%H%M%S`

function contained_by {
  local i

  for i in "${@:2}"; do [[ "${i}" == "${1}" ]] && return 0; done
  return 1
}

let dir_index=1

for data_dir in $data_dirs; do
  for keyspace in `find $data_dir -maxdepth 1 -mindepth 1 -type d -exec basename {} \;`; do
    if contained_by "${keyspace}" "${SKIP_KEYSPACES[@]}"; then continue; fi

    tarball="${work_dir}/$keyspace-$dir_index.tar.gz"

    if stat "$data_dir"/"$keyspace"/*/backups > /dev/null; then
      cd "$data_dir"

      # It's important to remove files in the backups directory as atomically
      # as possible because this directory is going to be updated as we read it
      tar --remove-files -czf "$tarball" "$keyspace"/*/backups

      trap "cd \"$old_pwd\"; exit" INT TERM EXIT

      /usr/local/bin/s3cmd put \
        --access_key $AWS_ACCESS_KEY_ID \
        --secret_key $AWS_SECRET_ACCESS_KEY \
        --server-side-encryption \
        --region $REGION \
        "$tarball" \
        "s3://$BUCKET/cassandra/<%= node.chef_environment %>/<%= node['fqdn'] %>/incrementals/$backup_date/$keyspace-$dir_index.tar.gz"

      rm -f "$tarball"

      trap - INT TERM EXIT
    else
      echo "Nothing to back up in $data_dir/$keyspace/*/backups"
    fi
  done
  let dir_index++
done

cd "$old_pwd"
