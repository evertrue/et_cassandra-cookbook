#!/usr/bin/env bash

set -e

let timeout=7200

<% if node['et_cassandra']['cronitor']['repairs']['enabled'] -%>
/usr/local/bin/cronitor_repairs run
<% end -%>

keyspaces=$(/usr/bin/cqlsh -e 'copy system.schema_keyspaces (keyspace_name) to stdout;' \
  | grep -v '^$\|rows exported\|Starting copy\|Written: ' \
  | sed 's/\r//g' \
  | grep -v '^\(system\|system_traces\|OpsCenter\)$')

for ks in $keyspaces; do
  echo "Running repair on keyspace $ks"
  /usr/bin/nodetool -h localhost repair "$ks" -pr || retval=$?
  if [ "$retval" ] && [[ $retval != 0 ]]; then
    echo "Repair of keyspace ${ks} failed with code ${retval}"
    <% if node['et_cassandra']['cronitor']['repairs']['enabled'] -%>
    /usr/local/bin/cronitor_repairs fail
    <% end -%>
    exit $retval
  fi
done

<% if node['et_cassandra']['cronitor']['repairs']['enabled'] -%>
/usr/local/bin/cronitor_repairs complete
<% end -%>
