#!/usr/bin/env bash

set -e

let timeout=7200

keyspaces=$(/usr/bin/cqlsh -e 'describe keyspaces;' \
  | awk 'RS="  " {print $0}' \
  | grep -v '^$' \
  | grep -v '^\(system\|system_traces\|\"OpsCenter\"\)$')

for ks in $keyspaces; do
  /usr/bin/nodetool -h localhost repair "$ks" -pr &
  nt_pid=$!

  echo "Waiting $timeout seconds to start the next repair job"
  sleep $timeout

  if ps o cmd= $nt_pid | grep -q nodetool; then
    msg="Repair of keyspace $ks still running after $timeout seconds"
    echo "$msg" | mail -s "Keyspace repair taking too long" root
  fi
done
